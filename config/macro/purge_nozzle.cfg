[gcode_macro PURGE_NOZZLE]
gcode: |
    {% set X = params.X|default(65)|float %} ; X-axis start position
    {% set Y = params.Y|default(350)|float %} ; Y-axis start position
    {% set PURGE_Z_OFFSET = params.PURGE_Z_OFFSET|default(5)|float %} ; Y-axis start position
    {% set PARK_SPEED = params.PARK_SPEED|default(300)|int %}

    {% set DECOMINATOR_X_MIN = params.X|default(65)|float %} ; X-axis start position
    {% set DECOMINATOR_X_MAX = params.X|default(130)|float %} ; X-axis start position
    {% set DECOMINATOR_Y_MIN = params.X|default(350)|float %} ; X-axis start position
    {% set DECOMINATOR_Y_MAX = params.X|default(350)|float %} ; X-axis start position

    {% set LENGTH = params.LENGTH|default(25)|float %} ; purge length
    {% set SPEED = params.SPEED|default(300)|int %} ; mm/min
    {% set RETRACTION_LENGTH = params.RETRACTION_LENGTH|default(10)|float %} ; retract distance after purge
    {% set RETRACTION_SPEED = params.RETRACTION_SPEED|default(600)|int %} ; retract distance after purge mm/min

    G0 X{X} Y{Y} Z{PURGE_Z_OFFSET} F{(PARK_SPEED * 60)}; park

    SAVE_GCODE_STATE NAME=purge_nozzle_state
    M117 Purging..
    beep TONE=1800 DURATION=100 REPETITIONS=2 DELAY=200
    G91
    M83
    G92 E0
    G1 E{LENGTH} F{SPEED}
    BEEP
    SLEEP MS=500
    G1 E{ -1 * RETRACTION_LENGTH} F{RETRACTION_SPEED}; retract 3mm

    G90

    SLEEP MS=10000 ; sleep 5 seconds to melt what left in nozzle.
    G0 X{DECOMINATOR_X_MAX} Y{DECOMINATOR_Y_MAX} F20000
    G0 X{DECOMINATOR_X_MIN} Y{DECOMINATOR_Y_MIN} F20000
    G0 X{DECOMINATOR_X_MAX} Y{DECOMINATOR_Y_MAX} F20000
    G0 X{DECOMINATOR_X_MIN} Y{DECOMINATOR_Y_MIN} F20000

    SLEEP MS=5 ; sleep 5 seconds to melt what left in nozzle.
    G0 X{DECOMINATOR_X_MAX} Y{DECOMINATOR_Y_MAX} F20000
    G0 X{DECOMINATOR_X_MIN} Y{DECOMINATOR_Y_MIN} F20000
    G0 X{DECOMINATOR_X_MAX} Y{DECOMINATOR_Y_MAX} F20000
    G0 X{DECOMINATOR_X_MIN} Y{DECOMINATOR_Y_MIN} F20000

    CLEAR_SCREEN
    RESTORE_GCODE_STATE NAME=purge_nozzle_state
